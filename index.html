<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个性化音乐生成器</title>
    <style>
        :root {
            --primary-bg: #000000;
            --secondary-bg: #111111;
            --border-color: #333333;
            --text-primary: #ffffff;
            --text-secondary: #666666;
            --accent-color: #ffffff;
            --error-color: #ff4444;
            --success-color: #00ff88;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: var(--primary-bg);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1.6;
        }

        .container {
            width: 100%;
            max-width: 600px;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header img {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 300;
            letter-spacing: 3px;
            margin-top: 20px;
            text-transform: uppercase;
        }

        .form-container {
            background: var(--secondary-bg);
            padding: 40px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            position: relative;
            margin-bottom: 30px;
        }

        .form-container::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, var(--accent-color), var(--border-color));
            z-index: -1;
            filter: blur(10px);
            opacity: 0.3;
            border-radius: 12px;
        }

        .input-group {
            margin-bottom: 25px;
        }

        .input-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .form-input {
            width: 100%;
            padding: 15px 20px;
            font-size: 16px;
            background: var(--primary-bg);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
        }

        .form-input::placeholder {
            color: var(--text-secondary);
        }

        .generate-btn {
            width: 100%;
            background: var(--accent-color);
            color: var(--primary-bg);
            border: none;
            padding: 18px;
            font-size: 16px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .generate-btn:hover:not(:disabled) {
            background: var(--primary-bg);
            color: var(--accent-color);
            border: 1px solid var(--accent-color);
            transform: translateY(-2px);
        }

        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading-spinner {
            display: none;
            width: 50px;
            height: 50px;
            margin: 30px auto;
            border: 3px solid var(--border-color);
            border-radius: 50%;
            border-top: 3px solid var(--accent-color);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .message {
            margin: 20px 0;
            padding: 15px 20px;
            border-radius: 5px;
            font-size: 14px;
            text-align: center;
            display: none;
        }

        .message.error {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid var(--error-color);
            color: var(--error-color);
        }

        .message.success {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid var(--success-color);
            color: var(--success-color);
        }

        .audio-player {
            display: none;
            background: var(--secondary-bg);
            padding: 30px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            text-align: center;
        }

        .play-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--accent-color);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 25px;
            transition: all 0.3s ease;
        }

        .play-button:hover {
            transform: scale(1.05);
            background: #f0f0f0;
        }

        .play-icon, .pause-icon {
            width: 0;
            height: 0;
        }

        .play-icon {
            border-left: 25px solid var(--primary-bg);
            border-top: 15px solid transparent;
            border-bottom: 15px solid transparent;
            margin-left: 8px;
        }

        .pause-icon {
            width: 20px;
            height: 30px;
            border-left: 8px solid var(--primary-bg);
            border-right: 8px solid var(--primary-bg);
        }

        .progress-container {
            width: 100%;
            height: 6px;
            background: var(--border-color);
            border-radius: 3px;
            cursor: pointer;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: var(--accent-color);
            border-radius: 3px;
            width: 0;
            transition: width 0.1s linear;
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .form-container {
                padding: 25px 20px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .form-input {
                padding: 12px 15px;
            }

            .generate-btn {
                padding: 15px;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5rem;
                letter-spacing: 2px;
            }

            .form-container {
                padding: 20px 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <img src="https://cdn.jsdelivr.net/gh/rain-yyy/bello_website/image.jpg" alt="音乐生成器Logo" onerror="this.style.display='none'">
            <h1>音乐生成器</h1>
        </header>
        
        <main>
            <div class="form-container">
                <form id="musicForm">
                    <div class="input-group">
                        <label for="nameInput" class="input-label">英文姓名</label>
                        <input 
                            type="text" 
                            id="nameInput" 
                            class="form-input" 
                            placeholder="请输入您的英文姓名" 
                            required 
                            autocomplete="name"
                        >
                    </div>
                    
                    <div class="input-group">
                        <label for="birthdayInput" class="input-label">出生日期</label>
                        <input 
                            type="date" 
                            id="birthdayInput" 
                            class="form-input" 
                            required
                            autocomplete="bday"
                        >
                    </div>
                    
                    <button type="submit" id="generateButton" class="generate-btn">
                        生成专属音乐
                    </button>
                </form>
                
                <div id="errorMessage" class="message error"></div>
                <div id="successMessage" class="message success"></div>
            </div>

            <div id="loadingSpinner" class="loading-spinner"></div>

            <div id="audioPlayer" class="audio-player">
                <button id="playButton" class="play-button" type="button">
                    <div class="play-icon"></div>
                </button>
                
                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                
                <div class="time-display">
                    <span id="currentTime">0:00</span>
                    <span id="totalDuration">0:00</span>
                </div>
                
                <audio id="audioElement" preload="metadata"></audio>
            </div>
        </main>
    </div>

    <script>
        // 配置项 - 在部署时需要修改为实际的服务器地址
        const CONFIG = {
            // 请在这里替换为您的服务器地址
            API_BASE_URL: 'http://13.213.156.99:8000',  // 例如: 'https://api.example.com'
            API_ENDPOINTS: {
                GENERATE_MUSIC: '/api/generate-music',
                HEALTH_CHECK: '/api/health'
            }
        };

        // DOM元素引用
        const elements = {
            form: document.getElementById('musicForm'),
            nameInput: document.getElementById('nameInput'),
            birthdayInput: document.getElementById('birthdayInput'),
            generateButton: document.getElementById('generateButton'),
            loadingSpinner: document.getElementById('loadingSpinner'),
            errorMessage: document.getElementById('errorMessage'),
            successMessage: document.getElementById('successMessage'),
            audioPlayer: document.getElementById('audioPlayer'),
            playButton: document.getElementById('playButton'),
            progressContainer: document.getElementById('progressContainer'),
            progressBar: document.getElementById('progressBar'),
            currentTime: document.getElementById('currentTime'),
            totalDuration: document.getElementById('totalDuration'),
            audioElement: document.getElementById('audioElement')
        };

        // 应用状态
        let isPlaying = false;
        let isLoading = false;

        // 工具函数
        const utils = {
            /**
             * 格式化时间显示
             * @param {number} seconds - 秒数
             * @returns {string} 格式化的时间字符串
             */
            formatTime(seconds) {
                if (isNaN(seconds)) return '0:00';
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = Math.floor(seconds % 60);
                return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
            },

            /**
             * 显示消息
             * @param {string} message - 消息内容
             * @param {string} type - 消息类型 ('error' | 'success')
             */
            showMessage(message, type = 'error') {
                this.hideAllMessages();
                const messageElement = type === 'error' ? elements.errorMessage : elements.successMessage;
                messageElement.textContent = message;
                messageElement.style.display = 'block';
            },

            /**
             * 隐藏所有消息
             */
            hideAllMessages() {
                elements.errorMessage.style.display = 'none';
                elements.successMessage.style.display = 'none';
            },

            /**
             * 设置加载状态
             * @param {boolean} loading - 是否正在加载
             */
            setLoading(loading) {
                isLoading = loading;
                elements.generateButton.disabled = loading;
                elements.loadingSpinner.style.display = loading ? 'block' : 'none';
                elements.generateButton.textContent = loading ? '生成中...' : '生成专属音乐';
                
                if (loading) {
                    this.hideAllMessages();
                    elements.audioPlayer.style.display = 'none';
                }
            },

            /**
             * 验证表单输入
             * @returns {Object} 验证结果和数据
             */
            validateForm() {
                const name = elements.nameInput.value.trim();
                const birthday = elements.birthdayInput.value;

                if (!name) {
                    return { valid: false, message: '请输入英文姓名' };
                }

                if (!birthday) {
                    return { valid: false, message: '请选择出生日期' };
                }

                // 验证英文字符（允许字母、空格、连字符）
                if (!/^[a-zA-Z\s\-]+$/.test(name)) {
                    return { valid: false, message: '姓名只能包含英文字母、空格和连字符' };
                }

                // 验证日期合理性
                const birthDate = new Date(birthday);
                const currentDate = new Date();
                const minDate = new Date('1900-01-01');

                if (birthDate > currentDate) {
                    return { valid: false, message: '出生日期不能晚于今天' };
                }

                if (birthDate < minDate) {
                    return { valid: false, message: '出生日期不能早于1900年' };
                }

                return { valid: true, data: { name, birthday } };
            }
        };

        // 音频播放器控制
        const audioController = {
            /**
             * 切换播放/暂停状态
             */
            togglePlay() {
                if (isPlaying) {
                    this.pause();
                } else {
                    this.play();
                }
            },

            /**
             * 播放音频
             */
            play() {
                elements.audioElement.play().then(() => {
                    isPlaying = true;
                    elements.playButton.innerHTML = '<div class="pause-icon"></div>';
                }).catch(error => {
                    console.error('播放失败:', error);
                    utils.showMessage('音频播放失败，请检查文件是否有效');
                });
            },

            /**
             * 暂停音频
             */
            pause() {
                elements.audioElement.pause();
                isPlaying = false;
                elements.playButton.innerHTML = '<div class="play-icon"></div>';
            },

            /**
             * 设置音频源并显示播放器
             * @param {string} audioUrl - 音频文件URL
             */
            loadAudio(audioUrl) {
                elements.audioElement.src = audioUrl;
                elements.audioPlayer.style.display = 'block';
                this.resetPlayer();
            },

            /**
             * 重置播放器状态
             */
            resetPlayer() {
                isPlaying = false;
                elements.playButton.innerHTML = '<div class="play-icon"></div>';
                elements.progressBar.style.width = '0%';
                elements.currentTime.textContent = '0:00';
                elements.totalDuration.textContent = '0:00';
            },

            /**
             * 更新播放进度
             */
            updateProgress() {
                const audio = elements.audioElement;
                if (audio.duration) {
                    const progress = (audio.currentTime / audio.duration) * 100;
                    elements.progressBar.style.width = progress + '%';
                    elements.currentTime.textContent = utils.formatTime(audio.currentTime);
                    elements.totalDuration.textContent = utils.formatTime(audio.duration);
                }
            },

            /**
             * 跳转到指定位置
             * @param {Event} event - 点击事件
             */
            seek(event) {
                const container = elements.progressContainer;
                const rect = container.getBoundingClientRect();
                const clickX = event.clientX - rect.left;
                const progress = clickX / rect.width;
                const audio = elements.audioElement;
                
                if (audio.duration) {
                    audio.currentTime = progress * audio.duration;
                }
            }
        };

        // API调用
        const apiService = {
            /**
             * 生成音乐
             * @param {Object} data - 包含name和birthday的对象
             * @returns {Promise<Object>} API响应
             */
            async generateMusic(data) {
                const url = `${CONFIG.API_BASE_URL}${CONFIG.API_ENDPOINTS.GENERATE_MUSIC}`;
                const params = new URLSearchParams({
                    name: data.name,
                    birthday: data.birthday
                });

                try {
                    const response = await fetch(`${url}?${params}`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        let errorMessage = `请求失败 (${response.status})`;
                        try {
                            const errorData = await response.json();
                            errorMessage = errorData.detail || errorMessage;
                        } catch (e) {
                            // 如果无法解析错误响应，使用默认错误消息
                        }
                        throw new Error(errorMessage);
                    }

                    return await response.json();
                } catch (error) {
                    console.error('API请求失败:', error);
                    if (error.name === 'TypeError' && error.message.includes('fetch')) {
                        throw new Error('无法连接到服务器，请检查网络连接或服务器地址配置');
                    }
                    throw error;
                }
            }
        };

        // 主要功能
        const musicGenerator = {
            /**
             * 处理表单提交
             * @param {Event} event - 表单提交事件
             */
            async handleFormSubmit(event) {
                event.preventDefault();
                
                if (isLoading) return;

                const validation = utils.validateForm();
                if (!validation.valid) {
                    utils.showMessage(validation.message);
                    return;
                }

                utils.setLoading(true);

                try {
                    const result = await apiService.generateMusic(validation.data);
                    
                    if (result.music_url) {
                        const fullAudioUrl = `${CONFIG.API_BASE_URL}${result.music_url}`;
                        audioController.loadAudio(fullAudioUrl);
                        utils.showMessage('音乐生成成功！点击播放按钮享受您的专属音乐', 'success');
                    } else {
                        throw new Error('服务器返回的数据格式错误');
                    }
                } catch (error) {
                    console.error('音乐生成失败:', error);
                    utils.showMessage(error.message || '音乐生成失败，请稍后重试');
                } finally {
                    utils.setLoading(false);
                }
            },

            /**
             * 初始化应用
             */
            init() {
                // 绑定事件监听器
                elements.form.addEventListener('submit', this.handleFormSubmit.bind(this));
                elements.playButton.addEventListener('click', audioController.togglePlay.bind(audioController));
                elements.progressContainer.addEventListener('click', audioController.seek.bind(audioController));
                
                // 音频事件监听器
                elements.audioElement.addEventListener('timeupdate', audioController.updateProgress.bind(audioController));
                elements.audioElement.addEventListener('ended', () => {
                    audioController.resetPlayer();
                });
                elements.audioElement.addEventListener('loadedmetadata', audioController.updateProgress.bind(audioController));
                
                // 清除初始错误消息
                utils.hideAllMessages();
                
                console.log('音乐生成器已初始化');
                
                // 提醒开发者配置API地址
                if (CONFIG.API_BASE_URL === 'https://your-server-domain.com') {
                    console.warn('⚠️ 请在代码中配置正确的API_BASE_URL地址');
                }
            }
        };

        // 页面加载完成后初始化应用
        document.addEventListener('DOMContentLoaded', musicGenerator.init.bind(musicGenerator));
    </script>
</body>
</html>

